<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contato — BrazilTrad</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body{background:#f2f5f7;font-family:Inter,Arial,Helvetica,sans-serif;margin:0;padding:40px 20px;}
    h1{color:#0F4C5C;text-align:center;margin:0 0 6px;font-size:30px}
    p.desc{color:#4b5563;text-align:center;margin:0 0 24px}
    .container{max-width:560px;margin:18px auto;background:#fff;padding:30px;border-radius:12px;box-shadow:0 6px 20px rgba(8,15,20,.06)}
    label{display:block;margin-top:12px;font-weight:600;color:#111827}
    input,textarea{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:8px;margin-top:6px;font-size:15px}
    textarea{min-height:120px;resize:vertical}
    .btn{display:block;width:100%;padding:14px;border-radius:8px;border:0;font-weight:700;cursor:pointer}
    .primary{background:#0F4C5C;color:#fff}
    .primary:hover{background:#12697a}
    .back{background:#063F4E;color:#fff;margin-top:12px;display:none}
    .msg{margin-top:14px;text-align:center;font-weight:700;display:none}
    .success{color:#057a55}
    .error{color:#b91c1c}
    .small{font-size:13px;color:#6b7280;margin-top:8px;text-align:center}
  </style>
</head>
<body>
  <main class="container" role="main" aria-labelledby="titulo">
    <h1 id="titulo">Contato</h1>
    <p class="desc">Preencha o formulário abaixo e entraremos em contacto.</p>

    <form id="contactForm" novalidate>
      <label for="name">Nome *</label>
      <input id="name" name="name" type="text" required>

      <label for="email">E-mail *</label>
      <input id="email" name="email" type="email" required>

      <label for="company">Empresa (opcional)</label>
      <input id="company" name="company" type="text">

      <label for="message">Mensagem *</label>
      <textarea id="message" name="message" required></textarea>

      <button id="sendBtn" class="btn primary" type="submit">Enviar</button>
      <button id="backBtn" class="btn back" type="button">Voltar ao site</button>

      <div id="formMsg" class="msg" role="status" aria-live="polite"></div>
      <div class="small">Depois de enviar, usa "Voltar ao site" para regressar à página anterior.</div>
    </form>
  </main>

<script>
/*
  Explicação breve:
  - POST para Zoho (WebToLeadForm) — guarda o lead no Zoho.
  - POST para Web3Forms apenas para o email interno (para rsequeira@braziltrad.com).
  - POST para Google Apps Script para enviar confirmação ao lead (usa Gmail).
  - Mostrar botão "Voltar ao site" somente depois de sucesso.
*/

/* === CONFIGURAÇÕES (substitui se necessário) === */
const ZOHO_URL = "https://crm.zoho.com/crm/WebToLeadForm";
const WEB3FORMS_URL = "https://api.web3forms.com/submit"; // usado para enviar email interno
const WEB3FORMS_ACCESS_KEY = "36b646fd-5467-4ff8-8a3a-9df90aae76fe"; // mantém o teu key
// URL do teu Google Apps Script (use o teu deployado que envia email via Gmail)
const GAS_SEND_EMAIL_URL = "https://script.google.com/macros/s/AKfycbz54mjdL83y4hUXPnPrwOtNxgwL5Q3TtrQ75yzljmpS-h8dSi50oCGojaSBGKGdxwkquQ/exec";
/* ============================================== */

const form = document.getElementById("contactForm");
const sendBtn = document.getElementById("sendBtn");
const backBtn = document.getElementById("backBtn");
const msgBox = document.getElementById("formMsg");

function showMessage(text, type){
  msgBox.textContent = text;
  msgBox.className = "msg " + (type === "ok" ? "success" : "error");
  msgBox.style.display = "block";
}

function hideMessage(){
  msgBox.style.display = "none";
}

form.addEventListener("submit", async function(e){
  e.preventDefault();
  hideMessage();
  sendBtn.disabled = true;

  const name = (form.name.value || "").trim();
  const email = (form.email.value || "").trim();
  const company = (form.company.value || "").trim();
  const message = (form.message.value || "").trim();

  if(!name || !email || !message){
    showMessage("Preencha os campos obrigatórios.", "err");
    sendBtn.disabled = false;
    return;
  }

  try{
    /* 1) Enviar para Zoho — criar lead */
    const zohoForm = new FormData();
    // campos ocultos / tokens do WebToLead que o Zoho gerou (mantém os que tens)
    zohoForm.append("xnQsjsdp", "3fd1731c66fbf93ea4e8cba470a7d2c3236fa48b9105a4c2e169800c6460cf13");
    zohoForm.append("xmIwtLD", "55bb49f2537e4ee9c2c0d22cdebef9a489a974853af1926bb998412b493ac61ffb6464561e419055979737b7f25d38f3");
    zohoForm.append("actionType", "TGVhZHM=");
    zohoForm.append("returnURL", "null");
    // mapeamento dos campos para Zoho
    zohoForm.append("Last Name", name);
    zohoForm.append("Email", email);
    zohoForm.append("Company", company);
    zohoForm.append("Description", message);

    // Não aguardamos resposta para bloquear; fazemos await para garantir tentativa.
    await fetch(ZOHO_URL, { method: "POST", body: zohoForm, mode: "no-cors" });

    /* 2) Enviar email interno (para rsequeira) via Web3Forms */
    const internal = new FormData();
    internal.append("access_key", WEB3FORMS_ACCESS_KEY);
    internal.append("subject", "Novo contacto recebido — BrazilTrad");
    internal.append("recipient", "rsequeira@braziltrad.com"); // garante que vai para Rui
    internal.append("from_name", "BrazilTrad");
    internal.append("message", `
      Novo contacto recebido:<br><br>
      <b>Nome:</b> ${escapeHtml(name)}<br>
      <b>Email:</b> ${escapeHtml(email)}<br>
      <b>Empresa:</b> ${escapeHtml(company)}<br><br>
      <b>Mensagem:</b><br>${escapeHtml(message)}
    `);
    // envia email interno (não aguardamos erro que bloqueie o lead)
    await fetch(WEB3FORMS_URL, { method:"POST", body: internal });

    /* 3) Enviar confirmação AO LEAD — via Google Apps Script (usa Gmail do proprietário)
       -> isto garante que o email sai para o lead (não fica preso ao endereço da conta Web3Forms)
       O Apps Script deve aceitar um POST JSON com { to, subject, body } e enviar por Gmail.
    */
    const leadPayload = {
      to: email,
      subject: "Recebemos a sua mensagem — BrazilTrad",
      body: `Olá ${escapeHtml(name)},\n\nRecebemos a sua mensagem. Em breve entraremos em contacto.\n\nObrigado,\nBrazilTrad`
    };

    // POST JSON para o teu Apps Script
    await fetch(GAS_SEND_EMAIL_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(leadPayload)
    });

    /* Se tudo OK */
    showMessage("Mensagem enviada com sucesso!", "ok");
    form.reset();
    backBtn.style.display = "block"; // só mostra depois do sucesso

  } catch(err){
    console.error(err);
    showMessage("Erro ao enviar. Tente novamente.", "err");
  } finally {
    sendBtn.disabled = false;
  }
});

/* Botão voltar — faz history.back() para regressar à posição anterior do site */
backBtn.addEventListener("click", function(){
  window.history.back();
});

/* Função simples para escapar HTML em strings que mostramos no corpo do email interno */
function escapeHtml(str){
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;")
    .replace(/\n/g, "<br>");
}
</script>
</body>
</html>
